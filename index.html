<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>踩地雷</title>
    <style>
        #game-area {
            outline: 1px solid #aaa;
            user-select: none;
            -webkit-user-drag: none;
        }

        #game-area img {
            width: 90%;
            height: 90%;
        }

        .mines {
            width: 25px;
            height: 25px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            float: left;
            text-align: center;
            line-height: 25px;
            position: relative;
            background: url(./images/1.png);
            background-size: 100%;
            background-repeat: no-repeat;
        }

        .not-mines {
            width: 25px;
            height: 25px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            float: left;
            text-align: center;
            line-height: 25px;
            position: relative;
        }

        .cover {
            width: 25px;
            height: 25px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            position: absolute;
            top: -1px;
            left: -1px;
            background: linear-gradient(135deg, black, blue);
        }

        .flag {
            width: 25px;
            height: 25px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            position: absolute;
            top: -1px;
            left: -1px;
            background-image: url(./images/flag.png),
                linear-gradient(135deg, black, blue);
            background-size: 100%;
        }

        #text {
            margin: 10px 0;
        }

        #text div {
            display: inline-block;
            width: 200px;
        }
    </style>
</head>

<body>
    <div id="sels">
        <select id="select">
            <option value="初級">初級</option>
            <option value="中級">中級</option>
            <option value="高級">高級</option>
        </select>
        <input id="start" type="button" value="點擊後開始遊戲">
    </div>
    <div id="text">
        <div>經過時間: <span id="time-left">0</span> 秒</div>
        <div>剩餘地雷: <span id="mines-left">-</span> 顆</div>
    </div>
    <div id="game-area"></div>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js'
        integrity='sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=='
        crossorigin='anonymous'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // 紀錄計時器ID，用來清除計時器
        let intervalID
        // 計算經過時間
        let time = 0
        // 預設地雷數量
        let mines = 10
        // 預設每列格子數
        let = lattices = 10

        // 隨機函數，最小值/最大值/抽幾個(不重複)，回傳陣列
        const rand = (min, max, n) => {
            const returnNums = []
            const nums = Array.from({ length: max - min + 1 }, (value, index) => {
                return index
            })

            while (returnNums.length < n) {
                const random = Math.floor(Math.random() * nums.length)
                returnNums.push(nums[random])
                nums.splice(random, 1)
            }
            returnNums.sort((a, b) => {
                return a - b
            })
            return returnNums
        }

        // mine為地雷數量，lattice為每列的格子數
        const game = function (mine, lattice) {
            // 決定遊戲區域長寬
            $('#game-area').css('width', `${25 * lattice}px`)
            $('#game-area').css('hight', `${25 * lattice}px`)
            // 地雷數量重置
            mines = mine
            $('#mines-left').text(mine)
            // 遊戲開始前鎖定遊戲區域事件
            $('#game-area').css('pointer-events', 'none')

            // 時間歸零
            time = 0
            $('#time-left').text(time)

            // 清除計時器
            clearInterval(intervalID)

            // 清空遊戲區域
            $('#game-area').empty()

            // 隨機地雷位置
            const minesPos = rand(0, lattice ** 2 - 1, mines)

            // 生成地雷
            for (let i = 0; i < lattice ** 2; i++) {
                if (minesPos.includes(i)) {
                    $('#game-area').append(`<div id="x${i % lattice}-y${Math.floor(i / lattice)}" class="mines closed"><div class="cover"></div></div>`)
                }
                else {
                    $('#game-area').append(`<div id="x${i % lattice}-y${Math.floor(i / lattice)}" class="not-mines closed"><div class="cover"></div></div>`)
                }
            }
        }

        // 計算周圍地雷數量
        const numOfMines = function (box) {
            let sum = 0
            const x = parseInt(box.parent().attr('id').match(/x[0-9]+/g)[0].slice(1))
            const y = parseInt(box.parent().attr('id').match(/y[0-9]+/g)[0].slice(1))

            for (let i = x - 1; i <= x + 1; i++) {
                if (i >= 0 && i < 25) {
                    for (let j = y - 1; j <= y + 1; j++) {
                        if (j >= 0 && j < 25) {
                            if ($(`#x${i}-y${j}`).hasClass('mines')) {
                                sum++
                            }
                        }
                    }
                }
            }

            // 如果sum=0，採周圍地雷(連鎖踩地雷)
            if (sum === 0) {
                for (let i = x - 1; i <= x + 1; i++) {
                    if (i >= 0 && i < 25) {
                        for (let j = y - 1; j <= y + 1; j++) {
                            if (j >= 0 && j < 25) {
                                if ($(`#x${i}-y${j}`).hasClass('closed')) {
                                    $(`#x${i}-y${j}`).children().trigger('click')
                                }
                            }
                        }
                    }
                }
                return ''
            }
            return sum
        }


        // 選擇難度
        $('select').on('input', function () {
            if ($('select').val() === '初級') {
                game(10, 10)
            }
            else if ($('select').val() === '中級') {
                game(45, 16)
            }
            else {
                game(99, 25)
            }
        })

        // 點擊開始遊戲
        $('#start').on('click', function () {
            // 觸發難度選擇
            $('select').trigger('input')
            // 開啟遊戲區域事件
            $('#game-area').css('pointer-events', 'auto')

            // 檢查過關/爆炸
            intervalID = setInterval(function () {
                // 計時並顯示
                time += 0.1
                $('#time-left').text(Math.floor(time))

                if (!$('.mines').hasClass('closed')) {
                    Swal.fire({
                        title: "炸!!!",
                        text: "炸!!!",
                    });
                    $('#game-area').css('pointer-events', 'none')
                    clearInterval(intervalID)
                }
                if (!$('.not-mines').hasClass('closed')) {
                    Swal.fire({
                        title: "過關",
                        text: "過關",
                    });
                    $('#game-area').css('pointer-events', 'none')
                    clearInterval(intervalID)
                }
            }, 100)
        })

        // 遊戲區域鎖住滑鼠右鍵選單
        $('#game-area').on('contextmenu', function (event) {
            event.preventDefault()
        })

        // 點擊方格
        $('#game-area').on('click', '.cover', function () {
            $(this).css('display', 'none')
            $(this).parent().removeClass('closed')

            if ($(this).parent().hasClass('mines')) {
                $('.mines').children().css('display', 'none')
                $('.mines').removeClass('closed')
            }
            else {
                $(this).parent().text(numOfMines($(this)))
            }
        })

        // 右鍵插旗子
        $('#game-area').on('contextmenu', '.cover', function () {
            $(this).removeClass('cover')
            $(this).addClass('flag')
            mines--
            $('#mines-left').text(mines)
        })

        // 右鍵拔旗子
        $('#game-area').on('contextmenu', '.flag', function () {
            $(this).removeClass('flag')
            $(this).addClass('cover')
            mines++
            $('#mines-left').text(mines)
        })

        // 預設為初級版面
        game(mines, lattices)
    </script>
</body>

</html>